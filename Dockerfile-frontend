# Stage 1: Build
FROM --platform=$BUILDPLATFORM node:22-alpine AS frontend-builder
WORKDIR /app
COPY frontend/package*.json ./
RUN --mount=type=cache,target=/root/.npm npm ci --prefer-offline
COPY frontend/ ./
RUN npm run build

# Stage 2: Runtime
FROM caddy:alpine
RUN apk add --no-cache libintl && apk add --no-cache --virtual .gettext gettext && \
    cp /usr/bin/envsubst /usr/local/bin/envsubst && apk del .gettext
COPY --from=frontend-builder /app/dist /srv
COPY Caddyfile-frontend /etc/caddy/Caddyfile
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh
EXPOSE 80
ENTRYPOINT ["/docker-entrypoint.sh"]
